@page "/users"
@inject IGenericRepository<User> user_repo
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@inject IMatDialogService MatDialogService
@rendermode InteractiveServer

@using BlazorBootstrap
@using SmartWorkoutDataAccess.Entities
@using SmartWorkoutDataAccess
@using SmartWorkoutDataAccess.Repositories

@using MatBlazor

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "Role2Policy")]

<PageTitle>Users</PageTitle>
<div class="header">
    <div class="title">Users</div>
    <div class="search_add_container">
        <div class="search_container">
            <input class="search_input" @bind="searchQuery" placeholder="Search..." />
            <button class="search_button" @onclick="Search">Search</button>
        </div>
        <button type="button" class="add_user_button" @onclick="AddUser">Add User</button>
    </div>
</div>

@if (users == null)
{
    <p><em>Loading...</em></p>
}
else
{
    foreach (var user in users){
        <div class="container">
            <div class="image">
                <img src="/Images/User_icon.png" alt="User Image" />
            </div>
            <div class="details">
                <div class="component">Name: @user.Name</div>
                <div class="component">Surname: @user.Surname</div>
                <div class="component">Phone: @if (user.Phone != null)
                    {
                        @user.Phone
                    }
                    else
                    {
                        <span>No data</span>
                    }</div>
                <div class="component">Email: @if (user.Email != null)
                    {
                        @user.Email
                    }
                    else
                    {
                        <span>No data</span>
                    }</div>
                <div class="component">Age: @if (user.Age != null)
                    {
                        @user.Age
                    }
                    else
                    {
                        <span>No data</span>
                    }</div>
                <div class="component">Weight: @if (user.Weight != null)
                    {
                        @user.Weight
                    }
                    else
                    {
                        <span>No data</span>
                    }
                    </div>
                <div class="buttons_div">
                    <button type="button" class="update_button" @onclick="() => UpdateUser(user.Id)">Edit</button>
                    <button type="button" class="delete_button" @onclick="() => DeleteUser(user.Id)">Remove</button>
                </div>
                <button type="button" class="view_workouts_button" @onclick="()=>ViewWorkouts(user.Id)">View Workouts</button>
            </div>
        </div>
    }
}



@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private IEnumerable<User>? users;
    private string searchQuery = "";
    private int userIdToDelete;
    public bool DisplayAlert { get; set; }

    Alert warningAlert;
    private async Task CloseAlert() => await warningAlert?.CloseAsync();

    public string user_id = "0";

    private async Task GetUserId()
    {
        var authenticationState = await authenticationStateTask;
        var user = authenticationState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.Claims.FirstOrDefault(c => c.Type == "UserID");
            if (userIdClaim != null)
            {
                user_id = userIdClaim.Value;
            }
            else
            {
                user_id = "User ID claim not found";
            }
        }
        else
        {
            user_id = "Not authenticated";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await GetUserId();
        users = (await user_repo.GetAll())
                .Where(u => u.Trainer_Id == Convert.ToInt32(user_id));
    }
    void AddUser()
    {
        NavManager.NavigateTo("/addUserForm");
    }
    void UpdateUser(int id)
    {
        NavManager.NavigateTo($"/updateUserFormId={id}");
    }

    async void DeleteUser(int id)
    {
        User temp_user = await user_repo.GetById(id);
        temp_user.Trainer_Id = 0;
        user_repo.Update(temp_user);
        //user_repo.Delete(id);
        NavManager.NavigateTo(NavManager.Uri, forceLoad: true);
        StateHasChanged();
    }
    void ViewWorkouts(int id)
    {
        NavManager.NavigateTo($"/workoutsUserId={id}");
    }
    private async Task Search()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            users = (await user_repo.GetAll())
                .Where(u => u.Trainer_Id == Convert.ToInt32(user_id));
        }
        else
        {
            users = (await user_repo.GetAll()).Where(u => u.Trainer_Id == Convert.ToInt32(user_id))
                .Where(u => u.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                            u.Surname.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                            u.Id.ToString().Equals(searchQuery, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }   
}   
    